# PRD: Нормоконтроль и трудозатраты

Дополнение к [project_prd.md](../project_prd.md). Описание функционала нормоконтроля документов (чертежи, техпроцессы) и учёта трудозатрат по техпроцессам.

---

## 1. Цели и границы

### 1.1 Трудозатраты
- **Цель:** дать пользователю возможность получать по техпроцессу или детали суммарное время (установка + машинное время) по операциям без ввода новых сущностей — только за счёт данных графа Neo4j.
- **Границы:** расчёт только по данным из графа (TechProcess → HAS_OPERATION → Operation с полями setup_time_min, machine_time_min). Учёт фактических человеко-часов по заказам (табель) в этот PRD не входит.

### 1.2 Нормоконтроль
- **Цель:** проверка чертежа или техпроцесса на соответствие требованиям ГОСТов и внутренних норм с формированием структурированного отчёта (пройден/не пройден, список проверок, замечания).
- **Границы:** один сценарий — «запустить проверку по номеру чертежа/техпроцесса или по пути к файлу чертежа»; сохранение статусов документов и журнала проверок — опционально (фаза 2).

---

## 2. Пользовательские сценарии

### 2.1 Трудозатраты
| Сценарий | Ввод пользователя | Ожидаемый результат |
|----------|-------------------|--------------------|
| Трудозатраты по техпроцессу | «Трудозатраты по техпроцессу ТП-001» / «Суммарное время по ТП-001» | Таблица операций с временем установки и машинным временем, итоговые суммы (total_setup_min, total_machine_min, total_min). |
| Трудозатраты по детали | «Трудоёмкость изготовления детали по чертежу 123-456» | Данные по техпроцессу, привязанному к этой детали: операции и суммарное время. |
| Трудозатраты по операции | «Сколько времени на операцию 5 в техпроцессе ТП-001?» | Время установки и машинное время для указанной операции. |

### 2.2 Нормоконтроль
| Сценарий | Ввод пользователя | Ожидаемый результат |
|----------|-------------------|--------------------|
| Нормоконтроль чертежа по номеру | «Проверь чертёж 123-456 на нормоконтроль» | Отчёт: перечень проверок (оформление, ЕСКД, ссылки на ГОСТы), по каждой — соответствует/не соответствует, итог (passed/failed), краткое summary. |
| Нормоконтроль чертежа по файлу | «Проведи нормоконтроль чертежа» + путь к файлу (или загрузка) | Анализ чертежа (VLM при необходимости), поиск релевантных ГОСТов, отчёт. |
| Нормоконтроль техпроцесса | «Проверь техпроцесс ТП-001 на соответствие нормам» | Данные техпроцесса из графа, поиск требований к оформлению ТП в документации, отчёт. |

---

## 3. Функциональные требования

### 3.1 Трудозатраты (фаза 1)

- **TR-LAB-1:** Text-to-Cypher генерирует запросы с использованием полей `Operation.setup_time_min`, `Operation.machine_time_min` и при необходимости агрегирующих функций (SUM, группировка по техпроцессу/детали).
- **TR-LAB-2:** В системном промпте схемы графа явно указаны эти поля и возможность расчёта трудозатрат.
- **TR-LAB-3:** В few-shot примерах присутствуют минимум один запрос на «трудозатраты / суммарное время по техпроцессу» и один — по детали/чертежу.
- **TR-LAB-4:** Ingestion техпроцессов (Excel) гарантированно заполняет setup_time_min и machine_time_min в узлах Operation (текущая реализация — без изменений, при необходимости расширить маппинг колонок).

### 3.2 Нормоконтроль (фаза 1)

- **TR-NC-1:** Реализован навык (endpoint) `POST /api/v1/skills/norm-control`, принимающий:
  - `document_type`: `drawing` | `tech_process`;
  - `identifier`: номер чертежа или номер техпроцесса (обязателен при document_type);
  - `image_path`: путь к файлу чертежа (опционально, для drawing при отсутствии в графе).
- **TR-NC-2:** Навык выполняет: (1) получение данных документа из графа и/или через VLM по image_path; (2) поиск релевантных требований (docs_search по ГОСТам/нормам); (3) один вызов LLM для формирования отчёта по заданному шаблону.
- **TR-NC-3:** Ответ навыка: JSON с полями `passed: bool`, `checks: list[{name: str, status: str, comment: str}]`, `summary: str`, при необходимости `document_info: dict`.
- **TR-NC-4:** В чат добавлен инструмент `norm_control` с описанием для LLM; при вызове чат обращается к `POST /skills/norm-control` и отображает пользователю отчёт.

### 3.3 Опционально (фаза 2)

- **TR-NC-5:** У узлов Drawing и TechProcess в Neo4j могут быть добавлены свойства: norm_control_status (DRAFT | IN_NORM_CONTROL | APPROVED | REJECTED), norm_control_at, norm_control_comment.
- **TR-NC-6:** В PostgreSQL таблица norm_control_log (id, document_type, document_id, checked_at, result, summary, details JSONB, checked_by_user_id) для истории проверок.
- **TR-LAB-5:** Отдельная страница или отчёт в UI «Трудозатраты»: выбор техпроцесса/детали, вывод таблицы операций и итогов (опционально).

---

## 4. Нефункциональные требования

- **НФ-1:** Запросы трудозатрат выполняются в рамках существующего инструмента enterprise_graph_search; дополнительная задержка — только из-за сложности Cypher (лимиты результата сохраняются).
- **НФ-2:** Нормоконтроль: один вызов навыка = один дополнительный вызов LLM для сводки отчёта; таймаут навыка — в пределах общих таймаутов чата/инструментов (например, 120 с).
- **НФ-3:** Качество отчёта нормоконтроля зависит от наличия в Qdrant релевантных ГОСТов и инструкций (папка documents/gosts/, индексация через существующий ETL).

---

## 5. Зависимости

- Существующие навыки: graph_search, docs_search, blueprint_vision; клиенты Neo4j, Qdrant, LLM (registry).
- Данные: техпроцессы с заполненными временами в графе; при необходимости — индексированные ГОСТы в Qdrant.

---

## 6. Критерии приёмки (фаза 1)

- [x] Пользователь в чате задаёт вопрос «Трудозатраты по техпроцессу ТП-001» и получает ответ с суммами времени по операциям и итогом (через enterprise_graph_search и расширенный Text-to-Cypher).
- [x] Пользователь запрашивает «Проверь чертёж X на нормоконтроль» и получает структурированный отчёт (passed/checks/summary).
- [x] Навык norm_control доступен по `POST /skills/norm-control` и зарегистрирован как инструмент чата.

---

## 7. Связанные документы

- [project_prd.md](../project_prd.md) — основной PRD проекта.
- [USER_GUIDE.md](USER_GUIDE.md) — руководство пользователя (после реализации — дополнить разделами «Трудозатраты» и «Нормоконтроль»).
